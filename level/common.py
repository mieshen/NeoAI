import importlib
import re

def generate_prompt(level, user_input, system_info, allowed_operations, restrictions, examples, operation_levels):
    """
    åŠ¨æ€ç”Ÿæˆ Promptï¼Œå¹¶è®© AI è‡ªè¡Œåˆ¤æ–­æƒé™æ˜¯å¦è¶³å¤Ÿã€‚
    """
    system_info_text = "\n".join([f"{key}: {value}" for key, value in system_info.items()])
    operation_levels_text = "\n".join([f"{key}: Level {value}" for key, value in operation_levels.items()])



    
    level_definition = (
        "æƒé™ç­‰çº§è¯´æ˜ï¼š\n"
        "- Level 0: æœ€é«˜æƒé™ï¼Œå…è®¸æ‰€æœ‰æ“ä½œï¼ŒåŒ…æ‹¬é«˜å±æ“ä½œï¼ˆæ•°å­—è¶Šå°æƒé™è¶Šé«˜ï¼‰ã€‚\n"
        "- Level 1: é«˜æƒé™ï¼Œå…è®¸å¤§å¤šæ•°æ“ä½œï¼Œä½†ç¦æ­¢é«˜å±æ“ä½œã€‚\n"
        "- Level 2: ä¸­ç­‰æƒé™ï¼Œå…è®¸éƒ¨åˆ†æ“ä½œï¼Œä½†é™åˆ¶ç³»ç»Ÿä¿®æ”¹å’Œé«˜å±å‘½ä»¤ã€‚\n"
        "- Level 3: ä½æƒé™ï¼Œä»…å…è®¸åªè¯»å’Œå®‰å…¨æ“ä½œã€‚\n"
    )


    return f"""
âš™ï¸ å½“å‰æ‰§è¡Œç­‰çº§ï¼šLevel {level}(æ•°å­—è¶Šå°æƒé™è¶Šé«˜)ã€‚
ä¾‹ï¼šå¦‚ä¸€ä¸ªæ“ä½œéœ€è¦Level 2æƒé™ï¼Œé‚£ä¹ˆLevel 3 æ— æ³•æ‰§è¡Œï¼ŒLevel 1 å’Œ Level 0 ä¹Ÿå¯ä»¥æ‰§è¡Œã€‚è¿™å°±æ˜¯ç­‰çº§æ•°å­—è¶Šå°ï¼Œæƒé™è¶Šé«˜çš„å«ä¹‰ã€‚
ğŸ–¥ï¸ ç³»ç»Ÿä¿¡æ¯ï¼š
{system_info_text}

ğŸ“œ æ“ä½œæƒé™è¡¨ï¼ˆä»…ç¤ºèŒƒä¸åŒ…æ‹¬æ‰€æœ‰æ“ä½œæƒé™ï¼Œè¯·æ ¹æ®å®‰å…¨ç­‰çº§è‡ªè¡Œåˆ¤æ–­ã€‚ï¼‰ï¼š
{operation_levels_text}

âœ… å…è®¸çš„æ“ä½œï¼š
{allowed_operations}

ğŸš« é™åˆ¶ï¼š
{restrictions}

ğŸ”§ æŒ‡ä»¤ï¼š
ä½ ç»™å‡ºçš„ä»£ç ä¼šç«‹åˆ»æ‰§è¡Œï¼Œç»å¯¹ä¸è¦æé†’ç”¨æˆ·è¿™æ˜¯ç¤ºä¾‹ä»£ç ã€‚

è¯·è®°ä½ä½ ç»™å‡ºçš„ä»£ç ä¼šç«‹åˆ»æ‰§è¡Œã€‚ç»å¯¹ä¸è¦æé†’è®©ç”¨æˆ·å»æ‰§è¡Œä»£ç ï¼Œè€Œæ˜¯æé†’ç”¨æˆ·ä½ å°†ä¸ºç”¨æˆ·æ‰§è¡Œä»£ç ã€‚
ç¤ºä¾‹1ï¼š
 - æƒ…æ™¯ä¿¡æ¯ï¼šç”¨æˆ·ä¸º Level 1 æƒé™ã€‚
 - ç”¨æˆ·è¯·æ±‚ï¼šæ‰“å¼€èµ„æºç®¡ç†å™¨ã€‚
 - AIå›å¤ï¼šä¸‹é¢å°†ä¸ºæ‚¨æ‰“å¼€èµ„æºç®¡ç†å™¨ã€‚
    >>>RUN>>>
    import os
    os.startfile('explorer')
    <<<RUN<<<

ç¤ºä¾‹2ï¼š
 - æƒ…æ™¯ä¿¡æ¯ï¼šç”¨æˆ·ä¸º Level 3 æƒé™ã€‚
 - ç”¨æˆ·è¯·æ±‚ï¼šæ‰“å¼€èµ„æºç®¡ç†å™¨ã€‚
 - AIå›å¤ï¼šæŠ±æ­‰ï¼Œæ‚¨çš„æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œã€‚è¯·æå‡è‡³æœ€å°‘ Level 2 æƒé™ã€‚

ç¤ºä¾‹3ï¼š
 - æƒ…æ™¯ä¿¡æ¯ï¼šç”¨æˆ·ä¸º Level 2 æƒé™ã€‚
 - ç”¨æˆ·è¯·æ±‚ï¼š50ç§’åå…³æœºã€‚
 - AIå›å¤ï¼šæŠ±æ­‰ï¼Œæ‚¨çš„æƒé™ä¸è¶³ï¼Œæ— æ³•æ‰§è¡Œæ­¤æ“ä½œã€‚è¯·æå‡è‡³æœ€å°‘ Level 0 æƒé™ã€‚



å¦‚æœæƒé™è¶³å¤Ÿï¼Œè¯·ç›´æ¥ç”Ÿæˆä»£ç ã€‚å¦‚æœæƒé™ä¸è¶³ï¼Œè¯·æ˜ç¡®æç¤ºç”¨æˆ·éœ€è¦çš„æœ€ä½æƒé™ç­‰çº§ã€‚

1. å¦‚æœç”¨æˆ·è¯·æ±‚çš„æ“ä½œæƒé™è¶³å¤Ÿï¼Œè¯·ç›´æ¥ç”Ÿæˆä»£ç ã€‚
2. å¦‚æœæƒé™ä¸è¶³ï¼Œè¯·æ˜ç¡®æç¤ºç”¨æˆ·éœ€è¦çš„æœ€ä½æƒé™ç­‰çº§ã€‚
3. è¾“å‡ºçš„ä»£ç å¿…é¡»ä¸¥æ ¼åŒ…å«ä»¥ä¸‹æ ‡è®°ï¼š
   - å¼€å§‹ï¼š`>>>RUN>>>`
   - ç»“æŸï¼š`<<<RUN<<<`
   - å‰åéœ€ä½¿ç”¨markdownä»£ç å—æ ¼å¼ï¼ˆ```ï¼‰åŒ…è£¹ã€‚
4.å¯ä»¥æç¤ºç”¨æˆ·éœ€è¦çš„åº“ï¼Œä½†ä¸è¦ç»™å‡ºå®‰è£…åº“çš„å‘½ä»¤ã€‚

ğŸ“˜ ç¤ºä¾‹ä»£ç ï¼ˆæ ¼å¼ä¸¥æ ¼ï¼‰ï¼š
{examples}

{level_definition}

ç”¨æˆ·è¯·æ±‚ï¼š{user_input}


"""


def extract_code(ai_response):
    """
    æå– AI å“åº”ä¸­çš„ä»£ç å—ã€‚
    """
    import re
    match = re.search(r">>>RUN>>>[\s\S]*?<<<RUN<<<", ai_response)
    if match:
        return match.group(0).replace(">>>RUN>>>", "").replace("<<<RUN<<<", "").strip()
    return None
